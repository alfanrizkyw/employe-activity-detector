<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Employee Activity Detector</title>

  <!-- Minimal modern styling -->
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#06b6d4;
      --muted:#94a3b8;
      --danger:#ff4d4f;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071224 0%, #071728 60%);color:#e6eef6}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{
      width:100%;max-width:1100px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;padding:18px;box-shadow:0 10px 40px rgba(2,6,23,0.7);display:grid;grid-template-columns:1fr 380px;gap:18px;
      border:1px solid rgba(255,255,255,0.03);
    }
    header{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:20px;letter-spacing:0.2px}
    .video-wrap{position:relative;border-radius:10px;overflow:hidden;background:#000;display:flex;flex-direction:column}
    video{width:100%;height:100%;aspect-ratio:16/9;object-fit:cover;background:#000}
    .overlay {
      position:absolute;inset:12px;pointer-events:none;display:flex;flex-direction:column;justify-content:space-between;
    }
    .status {
      align-self:flex-start;background:linear-gradient(90deg, rgba(0,0,0,0.5), rgba(255,255,255,0.02));
      padding:8px 12px;border-radius:10px;backdrop-filter: blur(6px);display:flex;gap:10px;align-items:center;
    }
    .badge {font-weight:700;padding:6px 10px;border-radius:999px;background:var(--glass);color:var(--muted);font-size:13px}
    .status .state {font-size:15px;font-weight:800}
    .detected {color:#7efc82}
    .not-detected {color:var(--danger)}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);border:none;color:#032024;padding:9px 12px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .panel{padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.003));border-radius:10px;border:1px solid rgba(255,255,255,0.02);height:100%;display:flex;flex-direction:column;gap:12px}
    .small{font-size:13px;color:var(--muted)}
    .log{flex:1;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px dashed rgba(255,255,255,0.02)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .watermark{position:fixed;left:12px;bottom:10px;opacity:0.6;color:var(--muted);font-size:12px}
    .big-alert{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .big-alert .text{
      pointer-events:none;padding:18px 26px;border-radius:12px;background:linear-gradient(90deg, rgba(0,0,0,0.6), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.02);font-size:28px;font-weight:800;color:var(--danger);transform:translateY(-8px);
      text-align:center;backdrop-filter: blur(6px)
    }
    .footer-small{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    /* Responsive */
    @media (max-width:980px){
      .card{grid-template-columns:1fr;max-width:920px}
      .panel{height:auto}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="Employee Activity Detector">
      <div>
        <header>
          <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,var(--accent), #02838f);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021218">
            ðŸ‘€
          </div>
          <div>
            <h1>Employee Activity Detector</h1>
            <div class="small">Realtime camera monitoring â€” alerts when user is not detected</div>
          </div>
        </header>

        <div style="height:16px"></div>

        <div class="video-wrap" id="videoCard">
          <video id="video" autoplay muted playsinline></video>
          <div class="overlay">
            <div style="display:flex;align-items:center;gap:12px">
              <div class="status" id="statusBadge" role="status" aria-live="polite">
                <div class="badge">Camera</div>
                <div class="state detected" id="detectionState">Initializing...</div>
              </div>
              <div class="controls" style="margin-left:8px;pointer-events:auto">
                <button class="btn" id="startBtn">Start</button>
                <button class="btn ghost" id="stopBtn">Stop</button>
              </div>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
              <div class="small">Model: BlazeFace Â· Interval: <span id="intervalLabel">400ms</span></div>
              <div class="small">Sensitivity:
                <input id="thresholdRange" type="range" min="0.1" max="0.6" step="0.05" value="0.35" />
              </div>
            </div>
          </div>

          <!-- big alert overlay -->
          <div class="big-alert" id="bigAlert" style="display:none">
            <div class="text">USER NOT DETECTED</div>
          </div>
        </div>
      </div>

      <aside class="panel" aria-label="Control panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Session Logs</div>
          <div class="small">Local timestamps (browser)</div>
        </div>

        <div class="small">Events:</div>
        <div class="log" id="logBox" tabindex="0" aria-live="polite">
          <table id="logTable" aria-describedby="log-desc">
            <thead>
              <tr><th>Event</th><th>Time</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="clearBtn">Clear Logs</button>
          <button class="btn ghost" id="downloadBtn">Download CSV</button>
        </div>

        <div style="flex:0 0 auto" class="footer-small">
          <div id="modelStatus" class="small">Model: not loaded</div>
          <div class="small">v1.0 Â· Project by Paan</div>
        </div>
      </aside>

    </div>
  </div>

  <div class="watermark">Project by Paan</div>

  <!-- Scripts: TensorFlow.js + BlazeFace -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>

  <script>
    // Strict mode
    (function(){
      const video = document.getElementById('video');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const thresholdRange = document.getElementById('thresholdRange');
      const intervalLabel = document.getElementById('intervalLabel');
      const detectionState = document.getElementById('detectionState');
      const bigAlert = document.getElementById('bigAlert');
      const modelStatus = document.getElementById('modelStatus');
      const logTableBody = document.querySelector('#logTable tbody');
      const clearBtn = document.getElementById('clearBtn');
      const downloadBtn = document.getElementById('downloadBtn');

      let model = null;
      let stream = null;
      let running = false;
      let detectInterval = 400; // ms
      let detectTimer = null;
      let notDetected = false;
      let speakTimer = null;
      let lastEventTime = null;
      let logs = []; // {event, timeISO}

      intervalLabel.textContent = detectInterval + 'ms';

      // utility: add log entry
      function addLog(eventName){
        const now = new Date();
        const iso = now.toISOString();
        const display = now.toLocaleString();
        logs.push({event: eventName, time: iso});
        const row = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = eventName;
        const td2 = document.createElement('td'); td2.textContent = display;
        row.appendChild(td1); row.appendChild(td2);
        logTableBody.insertBefore(row, logTableBody.firstChild);
      }

      function clearLogs(){
        logs = [];
        logTableBody.innerHTML = '';
      }

      function downloadCSV(){
        if(logs.length===0){ alert('No logs to download'); return; }
        let csv = 'Event,Time (ISO)\\n';
        logs.forEach(r => {
          csv += '"' + r.event.replace(/"/g,'""') + '","' + r.time + '"\\n';
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'ead_logs_' + (new Date().toISOString()) + '.csv';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      clearBtn.addEventListener('click', () => {
        if(confirm('Clear all logs?')) clearLogs();
      });
      downloadBtn.addEventListener('click', downloadCSV);

      // Speech: repeated until user returns
      function startSpeakingRepeat(){
        stopSpeakingRepeat();
        // speak immediately then every 1600ms
        const speakOnce = () => {
          try {
            // check if browser supports speech
            if(typeof speechSynthesis === 'undefined') return;
            const utter = new SpeechSynthesisUtterance('User Not Detected');
            utter.lang = 'en-US';
            utter.rate = 1;
            utter.pitch = 1;
            utter.volume = 1; // max
            // voice selection: try to pick a Google-like voice if available
            const voices = speechSynthesis.getVoices ? speechSynthesis.getVoices() : [];
            if(voices && voices.length){
              // try to prefer Google US English or similar
              const prefer = voices.find(v => /google/i.test(v.name) || /en-US/i.test(v.lang));
              if(prefer) utter.voice = prefer;
            }
            speechSynthesis.cancel(); // cancel any ongoing to make it loud and repeated
            speechSynthesis.speak(utter);
          } catch(e){
            console.warn('Speech error', e);
          }
        };
        // first call might have empty voices list; call once then set interval
        speakOnce();
        speakTimer = setInterval(() => {
          // only speak if still notDetected
          if(notDetected) speakOnce();
        }, 1600);
      }
      function stopSpeakingRepeat(){
        if(speakTimer) { clearInterval(speakTimer); speakTimer = null; }
        if(typeof speechSynthesis !== 'undefined') speechSynthesis.cancel();
      }

      async function startCamera(){
        try {
          stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
          video.srcObject = stream;
          await video.play();
          return true;
        } catch(err){
          alert('Could not access camera. Check permissions and that a camera is available.\\n\\nError: ' + err.message);
          return false;
        }
      }

      async function stopCamera(){
        if(stream){
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
        video.pause();
        video.srcObject = null;
      }

      async function loadModel(){
        try {
          modelStatus.textContent = 'Loading model...';
          // Load BlazeFace
          model = await blazeface.load();
          modelStatus.textContent = 'Model loaded (BlazeFace)';
          return model;
        } catch(err){
          modelStatus.textContent = 'Model failed to load';
          console.error(err);
          alert('Failed to load detection model: ' + err.message);
          throw err;
        }
      }

      async function detectLoop(){
        if(!running || !model) return;
        try {
          // estimateFaces returns an array for each face detection
          const returnTensors = false;
          const predictions = await model.estimateFaces(video, returnTensors);
          // predictions is an array; if length > 0 then face(s) found
          const threshold = parseFloat(thresholdRange.value);
          let faceFound = false;
          if(predictions && predictions.length){
            // Each prediction has probability (score) in .probability (array)
            for(const p of predictions){
              // p.probability might be a number or array
              let score = 0;
              if(typeof p.probability === 'number') score = p.probability;
              else if(Array.isArray(p.probability)) score = p.probability[0] || 0;
              else score = 1;
              if(score >= threshold){ faceFound = true; break; }
            }
          }

          if(faceFound){
            if(notDetected){
              // user has returned
              notDetected = false;
              bigAlert.style.display = 'none';
              detectionState.classList.remove('not-detected'); detectionState.classList.add('detected');
              detectionState.textContent = 'User Detected';
              addLog('User Returned');
              stopSpeakingRepeat();
            } else {
              detectionState.textContent = 'User Detected';
              detectionState.classList.remove('not-detected'); detectionState.classList.add('detected');
            }
          } else {
            if(!notDetected){
              // just became not detected
              notDetected = true;
              bigAlert.style.display = 'flex';
              detectionState.classList.remove('detected'); detectionState.classList.add('not-detected');
              detectionState.textContent = 'User Not Detected';
              addLog('User Not Detected');
              startSpeakingRepeat(); // start speech repeating
            } else {
              // keep showing not detected
              detectionState.textContent = 'User Not Detected';
            }
          }
        } catch(e){
          console.error('Detection error', e);
        } finally {
          if(running) detectTimer = setTimeout(detectLoop, detectInterval);
        }
      }

      async function startAll(){
        if(running) return;
        running = true;
        detectionState.textContent = 'Initializing...';
        modelStatus.textContent = 'Preparing camera...';
        const ok = await startCamera();
        if(!ok){ running=false; return; }
        try {
          if(!model) await loadModel();
        } catch(e){
          running=false;
          await stopCamera();
          return;
        }
        detectionState.textContent = 'Ready';
        modelStatus.textContent = 'Model loaded (BlazeFace)';
        addLog('Session Started');
        // warm up once
        await new Promise(r => setTimeout(r, 300));
        detectLoop();
      }

      async function stopAll(){
        if(!running) return;
        running = false;
        if(detectTimer) { clearTimeout(detectTimer); detectTimer = null; }
        stopSpeakingRepeat();
        await stopCamera();
        detectionState.textContent = 'Stopped';
        modelStatus.textContent = 'Stopped';
        bigAlert.style.display = 'none';
        addLog('Session Stopped');
      }

      // UI hooks
      startBtn.addEventListener('click', startAll);
      stopBtn.addEventListener('click', stopAll);

      // allow pressing space to mute speech (quick shortcut)
      window.addEventListener('keydown', e => {
        if(e.code === 'Space') {
          e.preventDefault();
          if(speechSynthesis) speechSynthesis.cancel();
        }
      });

      thresholdRange.addEventListener('input', ()=>{
        // show value approx
        const v = thresholdRange.value;
        thresholdRange.title = 'Confidence threshold: ' + v;
      });

      // Start automatically attempt (but user must allow camera)
      (async ()=>{
        // try to load model in background for speed
        try {
          modelStatus.textContent = 'Loading model in background...';
          model = await blazeface.load();
          modelStatus.textContent = 'Model loaded (BlazeFace)';
        } catch(e){
          modelStatus.textContent = 'Model not loaded';
          console.warn('Background model load failed', e);
        }
        // Optional: auto-start
        // startAll();
      })();

      // Graceful unload
      window.addEventListener('beforeunload', async ()=> {
        stopSpeakingRepeat();
        if(detectTimer) clearTimeout(detectTimer);
        await stopCamera();
      });

      // expose for debugging (optional)
      window._EAD = {
        startAll, stopAll, logs, clearLogs
      };

    })();
  </script>
</body>
</html>
